<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mortgage Payment Calculator</title> <!-- Rebuild -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f4f8;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 40px;
    }
    .container {
      display: flex;
      gap: 40px;
    }
    .calculator {
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
      width: 400px;
    }
    .calculator h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    .form-group {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .form-group label {
      width: 55%;
    }
    .form-group input,
    .form-group select {
      font-size: 13px;
      padding: 4px;
    }
    .form-group div {
      display: flex;
      gap: 4px;
      width: 45%;
    }
    .form-group div input {
      width: 60%;
    }
    .form-group div select {
      width: 40%;
    }
    .results {
      background: #eaf4fc;
      padding: 20px;
      border-radius: 10px;
      font-size: 16px;
    }
    .results p {
      margin: 10px 0;
    }
    .charts {
      margin-top: 20px;
    }
    .chart-wrapper {
      position: relative;
      width: 100%;
      max-width: 600px;
      aspect-ratio: 3 / 2;
      margin: 0 auto 30px;
      background: #fff;
      border-radius: 10px;
      padding: 10px;
    }
    .charts canvas {
      width: 100% !important;
      height: 100% !important;
    }
    .output {
      flex: 1;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="calculator">
    <h2>Advanced Loan Calculator</h2>

    <div class="form-group">
      <label for="amount">Home Price ($):</label>
      <select id="amount">
        <option value="100000">$100,000</option>
        <option value="150000">$150,000</option>
        <option value="200000">$200,000</option>
        <option value="250000">$250,000</option>
        <option value="300000">$300,000</option>
        <option value="400000">$400,000</option>
        <option value="500000">$500,000</option>
        <option value="600000">$600,000</option>
      </select>
    </div>

    <div class="form-group">
      <label for="downpayment">Down Payment:</label>
      <div>
        <input type="number" id="downpayment" placeholder="20000">
        <select id="dpType" title="Choose $ for fixed amount or % of home price">
          <option value="dollar">$</option>
          <option value="percent">%</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label for="rate">Interest Rate (%):</label>
      <input type="number" id="rate" step="0.01" placeholder="e.g. 5" style="width: 45%;">
    </div>

    <div class="form-group">
      <label for="years">Loan Term (years):</label>
      <input type="number" id="years" placeholder="e.g. 30" style="width: 45%;">
    </div>

    <div class="form-group">
      <label for="loanType">Loan Type:</label>
      <select id="loanType" style="width: 45%;">
        <option value="conventional">Conventional</option>
        <option value="fha">FHA</option>
        <option value="va">VA</option>
        <option value="usda">USDA</option>
      </select>
    </div>

    <div class="form-group">
      <label for="pmi">PMI:</label>
      <div>
        <input type="number" id="pmi" placeholder="e.g. 0.5">
        <select id="pmiType" title="Choose % of loan or fixed monthly dollar amount">
          <option value="percent">%</option>
          <option value="dollar">$</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label for="hoa">HOA Fees:</label>
      <div>
        <input type="number" id="hoa" placeholder="150">
        <select id="hoaType" title="Monthly, yearly, or % of home value">
          <option value="monthly">$/mo</option>
          <option value="yearly">$/yr</option>
          <option value="percent">%</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label for="insurance">Insurance:</label>
      <div>
        <input type="number" id="insurance" placeholder="1200">
        <select id="insuranceType" title="Yearly, monthly, or % of home value">
          <option value="yearly">$/yr</option>
          <option value="monthly">$/mo</option>
          <option value="percent">%</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label for="tax">Property Tax (%):</label>
      <input type="number" id="tax" step="0.01" placeholder="1.25" style="width: 45%;">
    </div>
  </div>

  <div class="output">
    <div class="results" id="results" style="display:none;">
  <table style="width:100%; border-collapse: collapse; background: #fff;">
    <thead>
      <tr>
        <th style="text-align:left; padding: 8px; border: 1px solid #ccc;">Payment</th>
        <th style="text-align:right; padding: 8px; border: 1px solid #ccc;">Amount</th>
      </tr>
    </thead>
    <tbody>
      <tr><td style="padding: 8px; border: 1px solid #ccc;">Loan Amount</td><td id="loanAmount" style="padding: 8px; text-align:right; border: 1px solid #ccc;"></td></tr>
      <tr><td style="padding: 8px; border: 1px solid #ccc;">Monthly Mortgage Payment</td><td id="monthly" style="padding: 8px; text-align:right; border: 1px solid #ccc;"></td></tr>
      <tr><td style="padding: 8px; border: 1px solid #ccc;">Total Monthly Payment</td><td id="totalMonthly" style="padding: 8px; text-align:right; border: 1px solid #ccc;"></td></tr>
      <tr><td style="padding: 8px; border: 1px solid #ccc;">Total HOA + Insurance Over Loan</td><td id="totalExtras" style="padding: 8px; text-align:right; border: 1px solid #ccc;"></td></tr>
      <tr><td style="padding: 8px; border: 1px solid #ccc;">Total PMI Paid</td><td id="totalPmi" style="padding: 8px; text-align:right; border: 1px solid #ccc;"></td></tr>
      <tr><td style="padding: 8px; border: 1px solid #ccc;">Total Interest Paid</td><td id="interest" style="padding: 8px; text-align:right; border: 1px solid #ccc;"></td></tr>
      <tr><th style="text-align:left; padding: 8px; border: 1px solid #ccc;">Final Repayment Amount</th><th id="finalRepayment" style="padding: 8px; text-align:right; border: 1px solid #ccc;"></th></tr>
    </tbody>
  </table>
</div>
    <div class="charts">
      <div class="chart-wrapper"><canvas id="paymentChart"></canvas></div>
      <canvas id="progressChart"></canvas>
    </div>
  </div>
</div>

<script>
let paymentChartInstance, progressChartInstance;

function calculateLoan() {
  const amount = parseFloat(document.getElementById('amount').value);
  const dpValue = parseFloat(document.getElementById('downpayment').value) || 0;
  const dpType = document.getElementById('dpType').value;
  const downpayment = dpType === 'percent' ? (dpValue / 100) * amount : dpValue;

  const rate = parseFloat(document.getElementById('rate').value) / 100 / 12;
  const years = parseFloat(document.getElementById('years').value);
  const months = years * 12;
  const equityThreshold = amount * 0.8;

  const pmiValue = parseFloat(document.getElementById('pmi').value) || 0;
  const pmiType = document.getElementById('pmiType').value;
  const pmiMonthly = pmiType === 'percent' ? ((amount - downpayment) * (pmiValue / 100)) / 12 : pmiValue;

  const hoaValue = parseFloat(document.getElementById('hoa').value) || 0;
  const hoaType = document.getElementById('hoaType').value;
  const hoaMonthly = hoaType === 'percent' ? (amount * (hoaValue / 100)) / 12 :
                     hoaType === 'yearly' ? hoaValue / 12 : hoaValue;

  const insuranceValue = parseFloat(document.getElementById('insurance').value) || 0;
  const insuranceType = document.getElementById('insuranceType').value;
  const insuranceMonthly = insuranceType === 'percent' ? (amount * (insuranceValue / 100)) / 12 :
                            insuranceType === 'monthly' ? insuranceValue : insuranceValue / 12;

  const taxRate = parseFloat(document.getElementById('tax').value) / 100 / 12 || 0;
  const monthlyTax = amount * taxRate;

  const loanAmount = amount - downpayment;
  const x = Math.pow(1 + rate, months);
  const monthly = (loanAmount * rate * x) / (x - 1);

  let balance = loanAmount;
  let totalPmi = 0;
  const amortizationSchedule = [];

  for (let i = 0; i < months; i++) {
    const interestPayment = balance * rate;
    const principalPayment = monthly - interestPayment;
    balance -= principalPayment;
    amortizationSchedule.push({ month: i, principal: principalPayment, interest: interestPayment, balance });
    if (balance > equityThreshold && i < months / 2) {
      totalPmi += pmiMonthly;
    }
  }

  const totalMonthly = monthly + hoaMonthly + insuranceMonthly + monthlyTax + (totalPmi / months);
  const total = monthly * months;
  const interest = total - loanAmount;
  const totalExtras = (hoaMonthly + insuranceMonthly + monthlyTax) * months;
  const finalRepayment = loanAmount + interest + totalExtras + totalPmi;

  document.getElementById('loanAmount').innerText = loanAmount.toLocaleString(undefined, {minimumFractionDigits: 2});
  document.getElementById('monthly').innerText = monthly.toLocaleString(undefined, {minimumFractionDigits: 2});
  document.getElementById('totalMonthly').innerText = totalMonthly.toLocaleString(undefined, {minimumFractionDigits: 2});
  document.getElementById('totalExtras').innerText = totalExtras.toLocaleString(undefined, {minimumFractionDigits: 2});
  document.getElementById('totalPmi').innerText = totalPmi.toLocaleString(undefined, {minimumFractionDigits: 2});
  document.getElementById('interest').innerText = interest.toLocaleString(undefined, {minimumFractionDigits: 2});
  document.getElementById('finalRepayment').innerText = finalRepayment.toLocaleString(undefined, {minimumFractionDigits: 2});
  document.getElementById('results').style.display = 'block';

  renderCharts({ loanAmount, interest, totalExtras, totalPmi, amortizationSchedule, years, hoaMonthly, insuranceMonthly, monthlyTax, pmiMonthly });
}

function renderCharts({ loanAmount, interest, totalExtras, totalPmi, amortizationSchedule, years, hoaMonthly, insuranceMonthly, monthlyTax, pmiMonthly }) {
  const currentYear = new Date().getFullYear();
  const yearlyLabels = Array.from({ length: years }, (_, i) => `${currentYear + i}`);
  const yearlyPrincipal = Array.from({ length: years }, (_, i) => amortizationSchedule.slice(i * 12, (i + 1) * 12).reduce((sum, p) => sum + p.principal, 0));
  const yearlyInterest = Array.from({ length: years }, (_, i) => amortizationSchedule.slice(i * 12, (i + 1) * 12).reduce((sum, p) => sum + p.interest, 0));
  const yearlyPMI = Array.from({ length: years }, (_, i) => (i < years / 2) ? pmiMonthly * 12 : 0);
  const yearlyExtras = Array.from({ length: years }, () => (hoaMonthly + insuranceMonthly + monthlyTax) * 12);
  const balanceLine = amortizationSchedule.filter((_, idx) => idx % 12 === 0).map(p => p.balance);

  if (paymentChartInstance) paymentChartInstance.destroy();
  if (progressChartInstance) progressChartInstance.destroy();

  paymentChartInstance = new Chart(document.getElementById('paymentChart'), {
    type: 'doughnut',
    data: {
      labels: ['Principal', 'Interest', 'HOA + Insurance + Tax', 'PMI'],
      datasets: [{
        label: 'Cost Breakdown',
        data: [loanAmount, interest, totalExtras, totalPmi],
        backgroundColor: ['#3498db', '#e67e22', '#2ecc71', '#9b59b6'],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: 1.5,
      plugins: {
        tooltip: {
          callbacks: {
            label: context => `${context.label}: $${context.raw.toLocaleString(undefined, {minimumFractionDigits: 2})}`
          },
          bodyFont: { size: 16 }
        },
        legend: {
          position: 'bottom',
          labels: { font: { size: 14 } }
        },
        datalabels: {
          display: true,
          color: '#fff',
          font: { weight: 'bold', size: 14 },
          formatter: value => `$${value.toLocaleString(undefined, {minimumFractionDigits: 2})}`
        }
      }
    },
    plugins: [ChartDataLabels]
  });

  progressChartInstance = new Chart(document.getElementById('progressChart'), {
    type: 'bar',
    data: {
      labels: yearlyLabels,
      datasets: [
        { label: 'Principal Payment', data: yearlyPrincipal, backgroundColor: '#3498db', stack: 'stack1' },
        { label: 'Interest Payment', data: yearlyInterest, backgroundColor: '#e67e22', stack: 'stack1' },
        { label: 'PMI Payment', data: yearlyPMI, backgroundColor: '#9b59b6', stack: 'stack1' },
        { label: 'HOA + Insurance + Tax', data: yearlyExtras, backgroundColor: '#2ecc71', stack: 'stack1' },
        { type: 'line', label: 'Remaining Balance', data: balanceLine, borderColor: '#34495e', borderWidth: 2, fill: false, yAxisID: 'yBalance', tension: 0.3 }
      ]
    },
    options: {
      responsive: true,
      scales: {
        x: { stacked: true },
        y: {
          type: 'linear',
          position: 'right',
          stacked: true,
          beginAtZero: true,
          title: { display: true, text: 'Payment Breakdown ($)' }
        },
        yBalance: {
          type: 'linear',
          position: 'left',
          beginAtZero: false,
          grid: { drawOnChartArea: false },
          title: { display: true, text: 'Remaining Balance ($)' }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: context => `${context.dataset.label}: $${context.raw.toFixed(2)}`
          }
        },
        legend: {
          position: 'bottom',
          labels: { font: { size: 12 } }
        }
      }
    }
  });
}

document.querySelectorAll('input, select').forEach(el => {
  el.addEventListener('input', () => {
    if (document.getElementById('amount').value && document.getElementById('rate').value && document.getElementById('years').value) {
      calculateLoan();
    }
  });
});
</script>
</body>
</html>
